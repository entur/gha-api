# Lint OpenAPI files found in /specs and store the result in BigQuery

name: Entur/Api/Lint

on: [push]

jobs:
  lint-and-store-result:
    name: OpenAPI Lint
    runs-on: ubuntu-24.04
    environment: dev
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout host repository
        uses: actions/checkout@v4

      # Setup Node.js, install Spectral CLI, and run Spectral Linting
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
      - name: Install Spectral CLI
        run: npm install -g @stoplight/spectral-cli
      - name: Run Spectral Linting
        id: lint
        run: spectral lint ./specs/* -o lint-result.json -f json --quiet || true

      - id: dump-result
        shell: bash
        run: cat lint-result.json

      - name: Count Errors and Warnings
        id: count-errors-and-warnings
        run: |
          ERRORS=$(jq '[.[] | select(.severity == 0)] | length' lint-result.json)
          WARNINGS=$(jq '[.[] | select(.severity == 1)] | length' lint-result.json)
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "Found $ERRORS errors and $WARNINGS warnings."
        shell: bash

      - id: login-gcp
        if: false #disabled for now
        name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2.1.2
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.SERVICE_ACCOUNT }}
          token_format: 'access_token'

      - id: write-to-bigquery
        if: false #disabled for now
        name: Write to BigQuery
        shell: bash
        run: |
          curl --request POST \
          'https://bigquery.googleapis.com/bigquery/v2/projects/ent-apidata-dev/datasets/api_lint/tables/lint_result/insertAll' \
          --header 'Authorization: Bearer ${{ steps.login-gcp.outputs.access_token }}' \
          --header 'Accept: application/json' \
          --header 'Content-Type: application/json' \
          --data '{"rows": [{"json": {"date": "2025-03-06", "service": "Test9", "rules_hash": "abc", "spec_hash": "def", "result": [{"rule": "entur-openapi-version", "category": "general", "severity": 0}]}}]}' \
            --compressed
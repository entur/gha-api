name: Entur/Api/Lint

on:
  workflow_call:
    inputs:
      file_glob:
        description: "which openAPI 3.x file(s) to lint"
        type: string
        default: "build/resources/main/static/*.json"

jobs:
  lint:
    name: OpenAPI Lint
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    env:
      GHA_API_LINT_FILE_GLOB: ${{ inputs.file_glob }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install Spectral CLI
        run: npm install -g @stoplight/spectral-cli

      - name: Run Spectral Linting
        id: linting
        run: spectral lint ${{ env.GHA_API_LINT_FILE_GLOB }} -o lint-result.json -f json --quiet || true

      - name: Count Errors and Warnings
        id: count
        run: |
          ERRORS=$(jq '[.[] | select(.severity == 0)] | length' lint-result.json)
          WARNINGS=$(jq '[.[] | select(.severity == 1)] | length' lint-result.json)
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "Found $ERRORS errors and $WARNINGS warnings."
        shell: bash